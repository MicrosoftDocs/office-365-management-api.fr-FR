---
ms.technology: o365-service-communications
ms.TocTitle: Troubleshooting the Office 365 Management Activity API
title: Résolution des problèmes de l’API Activité de gestion Office 365
description: Cet article présente les questions les plus fréquemment posées au Support Microsoft concernant cette API.
ms.ContentId: 50822603-a1ec-a754-e7dc-67afe36bb1b0
ms.topic: reference (API)
ms.date: ''
localization_priority: Priority
ms.openlocfilehash: a65c8dff39d80b57b1c885639be2e228e8119cb7
ms.sourcegitcommit: 263cfbc04033ea8a1d765215e8777739587818e0
ms.translationtype: HT
ms.contentlocale: fr-FR
ms.lasthandoff: 11/13/2020
ms.locfileid: "49021008"
---
# <a name="office-365-management-activity-api-faqs-and-troubleshooting"></a><span data-ttu-id="59065-103">FAQ sur l'API de l'activité de gestion d'Office 365 et résolution des problèmes</span><span class="sxs-lookup"><span data-stu-id="59065-103">Office 365 Management Activity API FAQs and troubleshooting</span></span>

<span data-ttu-id="59065-104">L'API de l'activité de gestion d'Office 365 (également connue sous le nom d' *API d'audit unifié* ) fait partie des offres de sécurité et de conformité d'Office 365, qui :</span><span class="sxs-lookup"><span data-stu-id="59065-104">The Office 365 Management Activity API (also known as the *Unified Auditing API* ) is a part of Office 365 security and compliance offerings, that:</span></span>

- <span data-ttu-id="59065-105">Elle autorise l’accès par programme à plusieurs charges de travail du pipeline d’audit (par exemple, SharePoint et Exchange).</span><span class="sxs-lookup"><span data-stu-id="59065-105">Allows programmatic access to multiple auditing pipeline workloads (such as SharePoint and Exchange)</span></span>

- <span data-ttu-id="59065-106">Elle est l’interface principale utilisée par un large éventail de produits tiers pour agréger et indexer les données d’audit.</span><span class="sxs-lookup"><span data-stu-id="59065-106">Is the main interface used by a variety of third-party vendor products to aggregate and index auditing data</span></span>

<span data-ttu-id="59065-107">L’API Activité de gestion ne doit pas être confondue avec l’API Communications de service Office 365.</span><span class="sxs-lookup"><span data-stu-id="59065-107">The Management Activity API shouldn't be confused with the Office 365 Service Communications API.</span></span> <span data-ttu-id="59065-108">L’API Activité de gestion vous permet d’auditer les activités des utilisateurs finals dans différentes charges de travail.</span><span class="sxs-lookup"><span data-stu-id="59065-108">The Management Activity API is for auditing end user activities in the various workloads.</span></span> <span data-ttu-id="59065-109">L’API Service Communications, quant à elle, sert à auditer l’état et les messages envoyés par les services disponibles dans Office 365 (par exemple, Dynamics CRM ou Identité du service).</span><span class="sxs-lookup"><span data-stu-id="59065-109">The Service Communications API is for auditing status and messages that are sent by the services that are available in Office 365 (such as Dynamics CRM or Identity Service).</span></span>
 
> [!NOTE]
> <span data-ttu-id="59065-110">Il y a eu un problème avec les événements appartenant à l’audit. Le type de contenu AzureActiveDirectory étant indisponible via l’API de l’activité de gestion de Microsoft 365 entre le 22 octobre 2020 et le 6 novembre 2020.</span><span class="sxs-lookup"><span data-stu-id="59065-110">There was an issue with events belonging to the Audit.AzureActiveDirectory content type not being available via the Office 365 Management Activity API between October 22, 2020 and November 6, 2020.</span></span> <span data-ttu-id="59065-111">Les événements de connexion Azure AD ne sont pas affectés par ce problème.</span><span class="sxs-lookup"><span data-stu-id="59065-111">Azure AD signin events were not affected by this issue.</span></span> <span data-ttu-id="59065-112">Les événements manquants pour la période d’impact seront disponibles au cours des prochains jours, et devraient prendre fin au plus tard le 20 novembre 2020.</span><span class="sxs-lookup"><span data-stu-id="59065-112">The missing events for the period of impact will be available over the next few days, and is expected to take no later than November 20, 2020 to complete.</span></span> <span data-ttu-id="59065-113">Dans certains cas, il est possible que les clients remarquent des données d’événement en double pour les événements générés entre le 26 octobre 2020 et le 05 novembre 2020.</span><span class="sxs-lookup"><span data-stu-id="59065-113">In some cases, customers might notice duplicate event data for events generated between October 26, 2020 and November 5, 2020.</span></span>

## <a name="frequently-asked-questions-about-the-office-365-management-activity-api"></a><span data-ttu-id="59065-114">Questions fréquemment posées sur l'API de l'activité de gestion d'Office 365</span><span class="sxs-lookup"><span data-stu-id="59065-114">Frequently asked questions about the Office 365 Management Activity API</span></span>

<span data-ttu-id="59065-115">**Comment intégrer à l’API Activité de gestion ?**</span><span class="sxs-lookup"><span data-stu-id="59065-115">**How do I onboard to the Management Activity API?**</span></span>

<span data-ttu-id="59065-116">Pour commencer à utiliser l’API Activité de gestion Office 365, reportez-vous à [Prise en main des API de gestion Office 365](get-started-with-office-365-management-apis.md).</span><span class="sxs-lookup"><span data-stu-id="59065-116">To get started with the Office 365 Management Activity API, see [Get started with Office 365 Management APIs](get-started-with-office-365-management-apis.md).</span></span>

<span data-ttu-id="59065-117">**Que se passe-t-il si je désactive l’audit pour mon organisation Office 365 ? Est-ce que je reçois encore des événements via l’API Activité de gestion ?**</span><span class="sxs-lookup"><span data-stu-id="59065-117">**What happens if I disable auditing for my Office 365 organization? Will I still get events via the Management Activity API?**</span></span>

<span data-ttu-id="59065-118">Non.</span><span class="sxs-lookup"><span data-stu-id="59065-118">No.</span></span> <span data-ttu-id="59065-119">L’audit unifié d’Office 365 doit être activé pour votre organisation pour que les enregistrements puissent être collectés via l’API Activité de gestion.</span><span class="sxs-lookup"><span data-stu-id="59065-119">Office 365 unified auditing must be enabled for your organization to pull records via the Management Activity API.</span></span> <span data-ttu-id="59065-120">Pour obtenir des instructions, voir [Activer ou désactiver la recherche dans le journal d'audit](https://docs.microsoft.com/microsoft-365/compliance/turn-audit-log-search-on-or-off).</span><span class="sxs-lookup"><span data-stu-id="59065-120">For instructions, see [Turn audit log search on or off](https://docs.microsoft.com/microsoft-365/compliance/turn-audit-log-search-on-or-off).</span></span>

<span data-ttu-id="59065-121">**Quels événements sont audités pour un service Office 365 spécifique ?**</span><span class="sxs-lookup"><span data-stu-id="59065-121">**What events are audited for a specific Office 365 service?**</span></span>

<span data-ttu-id="59065-122">La documentation du schéma de l’API Activité de gestion Office 365 comprend la liste complète des événements.</span><span class="sxs-lookup"><span data-stu-id="59065-122">Office 365 Management Activity API schema documentation has a comprehensive list of events.</span></span> <span data-ttu-id="59065-123">Pour plus d’informations, voir le Schéma de l’API Activité de gestion Office 365.</span><span class="sxs-lookup"><span data-stu-id="59065-123">For details, see Office 365 Management Activity API schema.</span></span> <span data-ttu-id="59065-124">Consultez également la section « Activités auditées » dans [Effectuer des recherches dans le journal d’audit dans le Centre de sécurité et conformité](https://docs.microsoft.com/microsoft-365/compliance/search-the-audit-log-in-security-and-compliance#audited-activities) pour obtenir la liste des événements de la plupart des services Office 365 audités.</span><span class="sxs-lookup"><span data-stu-id="59065-124">Also see the "Audited activities" section in [Search the audit log in the Security & Compliance Center](https://docs.microsoft.com/microsoft-365/compliance/search-the-audit-log-in-security-and-compliance#audited-activities) for a list of events for most of the Office 365 services that are audited.</span></span>

<span data-ttu-id="59065-125">**Existe-t-il des différences entre les enregistrements récupérés par l’API Activité de gestion et les enregistrements renvoyés à l’aide de l’outil de recherche de journal d’audit dans le Centre de sécurité et conformité Microsoft 365 ?**</span><span class="sxs-lookup"><span data-stu-id="59065-125">**Are there any differences in the records that are fetched by the Management Activity API versus the records that are returned by using the audit log search tool in the Microsoft 365 compliance center?**</span></span>

<span data-ttu-id="59065-126">Les données renvoyées par les deux méthodes sont identiques.</span><span class="sxs-lookup"><span data-stu-id="59065-126">The data that is returned by both methods is the same.</span></span> <span data-ttu-id="59065-127">La seule différence réside dans le fait que, avec l’API, vous pouvez obtenir des données pour les 7 derniers jours uniquement (plus de détails dans les questions ci-dessous).</span><span class="sxs-lookup"><span data-stu-id="59065-127">The only difference is that with the API, you can get data for the last 7 days only (more details in the questions below).</span></span> <span data-ttu-id="59065-128">Lors de la recherche du journal d’audit dans le Centre de sécurité et conformité (ou à l’aide de la cmdlet **Search-UnifiedAuditLog** correspondante dans Exchange Online PowerShell), vous pouvez obtenir les données de la période de rétention en vigueur lorsque les données sont générées (par exemple, 90 jours ou un an).</span><span class="sxs-lookup"><span data-stu-id="59065-128">When searching the audit log in the Security & Compliance Center (or by using the corresponding **Search-UnifiedAuditLog** cmdlet in Exchange Online PowerShell), you can get data for the retention period in effect when the data is generated (for example, 90 days or one year).</span></span>

<span data-ttu-id="59065-129">**Quel est le délai maximum d'attente avant l'envoi d'une notification concernant un événement donné d'Office 365 ?**</span><span class="sxs-lookup"><span data-stu-id="59065-129">**What is the maximum time I will have to wait before a notification is sent about a given Office 365 event?**</span></span>

<span data-ttu-id="59065-130">Il n'y a pas de délai maximal garanti pour la livraison des notifications (en d'autres termes, pas de contrat de niveau de service).</span><span class="sxs-lookup"><span data-stu-id="59065-130">There is no guaranteed maximum latency for notification delivery (in other words, there is no SLA).</span></span> <span data-ttu-id="59065-131">En règle générale, la plupart des notifications sont envoyées dans l’heure suivant l’événement.</span><span class="sxs-lookup"><span data-stu-id="59065-131">Typically, most notifications are sent within one hour of the event.</span></span> <span data-ttu-id="59065-132">Le délai est souvent beaucoup plus court, mais il peut être plus long, car il peut varier en fonction de la charge de travail.</span><span class="sxs-lookup"><span data-stu-id="59065-132">Often the latency is much shorter, but this period might be longer since this varies from workload to workload.</span></span>

<span data-ttu-id="59065-133">**Les notifications webhook ne sont-elles pas plus immédiates ?**</span><span class="sxs-lookup"><span data-stu-id="59065-133">**Aren't webhook notifications more immediate?**</span></span>

<span data-ttu-id="59065-134">Non.</span><span class="sxs-lookup"><span data-stu-id="59065-134">No.</span></span> <span data-ttu-id="59065-135">Dernièrement, les délais des notifications sont plus longs avec un webhook qu’en interrogeant directement l’API à l’aide de l’opération `/content`.</span><span class="sxs-lookup"><span data-stu-id="59065-135">Recently, there have been longer wait times for notifications when using a webhook compared to querying the API directly with the `/content` operation.</span></span>

<span data-ttu-id="59065-136">**Pendant combien de temps le contenu restera-t-il disponible pour récupération via l’API ?**</span><span class="sxs-lookup"><span data-stu-id="59065-136">**How long will the content remain available to fetch via the API?**</span></span>

<span data-ttu-id="59065-137">Le contenu est disponible pour récupération via l’API pendant 7 jours après l’envoi de la notification de disponibilité.</span><span class="sxs-lookup"><span data-stu-id="59065-137">Content is available to fetch via the API for 7 days after the notification of the content availability.</span></span> <span data-ttu-id="59065-138">Même si la notification est retardée pendant un certain temps (par exemple, dans le cas d’une interruption de service), il vous reste 7 jours après la date d’envoi initial de la notification pour télécharger le blob de contenu lié à l’événement d’origine.</span><span class="sxs-lookup"><span data-stu-id="59065-138">Even if the notification is delayed for an unusually long period (for example, in the case of a service interruption), you would still have 7 days after the first availability of the notification to download the content blob related to the originating event.</span></span>

<span data-ttu-id="59065-139">**Puis-je interroger l'API d'activité de gestion pour un ID d'événement ou un RecordType particulier ou d'autres propriétés dans le blob de contenu ?**</span><span class="sxs-lookup"><span data-stu-id="59065-139">**Can I query the Management Activity API for a particular event ID or RecordType or other properties in the content blob?**</span></span>

<span data-ttu-id="59065-140">Non.</span><span class="sxs-lookup"><span data-stu-id="59065-140">No.</span></span> <span data-ttu-id="59065-141">L’API de gestion des activités fournit tous les détails de l’événement pour un journal particulier.</span><span class="sxs-lookup"><span data-stu-id="59065-141">The Management Activity API provides all the event details for a particular log.</span></span> <span data-ttu-id="59065-142">Elle peut être utilisée pour télécharger les détails complets, puis vous pouvez implémenter votre propre logique de requête sur les données téléchargées. Par exemple, à l’aide d’une application personnalisée ou d’un outil tiers.</span><span class="sxs-lookup"><span data-stu-id="59065-142">It can be used to download the entire details, and then you can implement your own query logic on the downloaded data; for example, by using a custom application or a third-party tool.</span></span>

<span data-ttu-id="59065-143">**Comment savoir si les données provenant de ma solution d’audit existante, qui collecte des données auprès de l’API Activité de gestion, sont précises et complètes ?**</span><span class="sxs-lookup"><span data-stu-id="59065-143">**How do I know the data coming from my existing auditing solution, which collects data from the Management Activity API, is accurate and complete?**</span></span>

<span data-ttu-id="59065-144">En bref, Microsoft ne fournit aucun type de journal qui vous permet de vérifier une application donnée ou tierce (ISV).</span><span class="sxs-lookup"><span data-stu-id="59065-144">The short answer is that Microsoft doesn't provide any kind of a log that allows you to cross-check any given application or third-party (ISV) application.</span></span> <span data-ttu-id="59065-145">Il existe d'autres produits de sécurité Microsoft qui obtiennent leurs données à partir du même pipeline, mais ils n'entrent pas dans le cadre de cette discussion et ne peuvent pas être utilisés pour recouper directement l'API Activité de gestion.</span><span class="sxs-lookup"><span data-stu-id="59065-145">There are other Microsoft security products that obtain their data from the same pipeline, but those products fall outside the scope of this discussion and can't be used to directly cross-check the Management Activity API.</span></span> <span data-ttu-id="59065-146">Si vous vous préoccupez des différences pouvant exister entre ce que votre solution vous fournit et ce dont vous en attendez, nous vous recommandons d’implémenter les opérations illustrées ci-dessus.</span><span class="sxs-lookup"><span data-stu-id="59065-146">If you're concerned about discrepancies between what your existing solution is providing and what you expect, you should implement the operations illustrated above.</span></span> <span data-ttu-id="59065-147">Cette démarche peut être difficile à réaliser selon la méthode employée par votre outil ou votre solution pour lister et indexer les données.</span><span class="sxs-lookup"><span data-stu-id="59065-147">But this can be difficult, depending on how your existing tool or solution lists and indexes data.</span></span> <span data-ttu-id="59065-148">Si votre solution existante ne présente que des données triées par heure de création de l'événement, il n'y a aucun moyen d'interroger l'API par heure de création de l'événement afin de comparer les ensembles de résultats.</span><span class="sxs-lookup"><span data-stu-id="59065-148">If your existing solution only presents data sorted by the creation time of the actual event, there's no way to query the API by event creation time so that you can compare result sets.</span></span> <span data-ttu-id="59065-149">Dans ce cas, il faudrait collecter les blobs de contenu notifiés pendant plusieurs jours, les indexer ou les trier manuellement, puis faire une comparaison manuelle.</span><span class="sxs-lookup"><span data-stu-id="59065-149">In this scenario, you'd have to collect the notified content blobs for several days, index or sort them manually, and then do a manual comparison.</span></span>

<span data-ttu-id="59065-150">**Quel est le seuil de limitation pour l’API Activité de gestion ?**</span><span class="sxs-lookup"><span data-stu-id="59065-150">**What is the throttling limit for the Management Activity API?**</span></span>

<span data-ttu-id="59065-151">Les organisations reçoivent une ligne de base de 2 000 demandes par minute.</span><span class="sxs-lookup"><span data-stu-id="59065-151">All organizations are initially allocated a baseline of 2,000 requests per minute.</span></span> <span data-ttu-id="59065-152">La limite de limitation est ensuite ajustée sur la base d’une combinaison de facteurs, notamment le nombre de sièges au sein de l’organisation.</span><span class="sxs-lookup"><span data-stu-id="59065-152">The throttling limit is then adjusted based on a combination of factors, including the number of seats in the organization.</span></span> <span data-ttu-id="59065-153">En outre, les organisations Office 365 E5 et Microsoft 365 E5 disposeront d’environ deux fois plus de bande passante que les organisations autres que E5.</span><span class="sxs-lookup"><span data-stu-id="59065-153">Also, Office 365 E5 and Microsoft 365 E5 organizations will get approximately twice as much bandwidth as non-E5 organizations.</span></span> <span data-ttu-id="59065-154">La bande passante aura également un plafond maximal pour protéger l’état d’intégrité du service.</span><span class="sxs-lookup"><span data-stu-id="59065-154">There will also be cap on the maximum bandwidth to protect the health of the service.</span></span>

> [!NOTE]
> <span data-ttu-id="59065-155">Même si chaque client peut initialement envoyer 2 000 requêtes par minute, Microsoft ne peut garantir le taux de réponse.</span><span class="sxs-lookup"><span data-stu-id="59065-155">Even though each tenant can initially submit up to 2,000 requests per minute, Microsoft cannot guarantee a response rate.</span></span> <span data-ttu-id="59065-156">Le taux de réponse dépend de différents facteurs, tels que les performances du système client, la capacité et la vitesse du réseau.</span><span class="sxs-lookup"><span data-stu-id="59065-156">The response rate depends on various factors, such as client system performance, network capacity, and network speed.</span></span>

<span data-ttu-id="59065-157">**Je rencontre une erreur de limitation dans l’API Activité de gestion. Que dois-je faire ?**</span><span class="sxs-lookup"><span data-stu-id="59065-157">**I'm encountering a throttling error in the Management Activity API. What should I do?**</span></span>

<span data-ttu-id="59065-158">Ouvrez un ticket avec le Support Microsoft et demandez un nouveau seuil de limitation et incluez une justification professionnelle pour augmenter la limite.</span><span class="sxs-lookup"><span data-stu-id="59065-158">Open a ticket with Microsoft Support and request a new throttling limit, and include a business justification for increasing the limit.</span></span> <span data-ttu-id="59065-159">Nous évaluerons la demande et si nous l’acceptons, nous augmenterons le seuil de limitation.</span><span class="sxs-lookup"><span data-stu-id="59065-159">We will evaluate the request, and if accepted, we will increase the throttling limit.</span></span>

<span data-ttu-id="59065-160">**Pourquoi les propriétés TargetUpdatedProperties n’apparaissent plus dans ExtendedProperties dans les journaux d’audit associés aux activités d’Azure Active Directory ?**</span><span class="sxs-lookup"><span data-stu-id="59065-160">**Why are TargetUpdatedProperties no longer in ExtendedProperties in the audit logs for Azure Active Directory activities?**</span></span>

<span data-ttu-id="59065-161">Les propriétés TargetUpdatedProperties figuraient dans ExtendedProperties.</span><span class="sxs-lookup"><span data-stu-id="59065-161">TargetUpdatedProperties were appearing in ExtendedProperties.</span></span> <span data-ttu-id="59065-162">Toutefois, elles ont été supprimées de ExtendedProperties et apparaissent désormais dans ModifiedProperties.</span><span class="sxs-lookup"><span data-stu-id="59065-162">However, they have been removed from ExtendedProperties and now appear in ModifiedProperties.</span></span>

## <a name="troubleshooting-the-office-365-management-activity-api"></a><span data-ttu-id="59065-163">Résolution des problèmes de l’API Activité de gestion Office 365</span><span class="sxs-lookup"><span data-stu-id="59065-163">Troubleshooting the Office 365 Management Activity API</span></span>

<span data-ttu-id="59065-164">Tout d’abord, les personnes qui utilisent pour la première fois l’API Activité de gestion Office 365 doivent savoir que les charges de travail ne peuvent être interrogées en fonction des spécificités d’un événement (par exemple la date à laquelle l’événement s’est produit, la collection de sites à partir de laquelle l’événement a été déclenché ou le type d’événement).</span><span class="sxs-lookup"><span data-stu-id="59065-164">One thing that should be made clear for anyone who's getting started with the Office 365 Management Activity API is that there is no concept of querying by event specifics, such as date that the event occurred, which site collection an event might have been fired from, or the type of event.</span></span> <span data-ttu-id="59065-165">En effet, vous devez créer des abonnements à des charges de travail spécifiques (par exemple, SharePoint ou Azure AD), chaque abonnement correspondant à un seul locataire.</span><span class="sxs-lookup"><span data-stu-id="59065-165">Instead, you create subscriptions to specific workloads (for example, SharePoint or Azure AD) and each subscription is per tenant.</span></span>

<span data-ttu-id="59065-166">Les sections suivantes résument les questions les plus fréquentes que les clients se posent lors de l’utilisation de l’API d’activité de gestion d’Office 365 :</span><span class="sxs-lookup"><span data-stu-id="59065-166">The following sections summarizes the most common questions that customers have in using the Office 365 Management Activity API:</span></span>

- [<span data-ttu-id="59065-167">Questions sur les clients et les outils tiers</span><span class="sxs-lookup"><span data-stu-id="59065-167">Questions about third-party tools and clients</span></span>](#questions-about-third-party-tools-and-clients)

- [<span data-ttu-id="59065-168">Activation du journal d’audit unifié dans Office 365</span><span class="sxs-lookup"><span data-stu-id="59065-168">Enabling unified audit logging in Office 365</span></span>](#enabling-unified-audit-logging-in-office-365)

- [<span data-ttu-id="59065-169">Connexion à l’API</span><span class="sxs-lookup"><span data-stu-id="59065-169">Connecting to the API</span></span>](#connecting-to-the-api)

- [<span data-ttu-id="59065-170">Vérification de vos abonnements</span><span class="sxs-lookup"><span data-stu-id="59065-170">Checking your subscriptions</span></span>](#checking-your-subscriptions)

- [<span data-ttu-id="59065-171">Création d’un nouvel abonnement</span><span class="sxs-lookup"><span data-stu-id="59065-171">Creating a new subscription</span></span>](#creating-a-new-subscription)

- [<span data-ttu-id="59065-172">Utilisation des webhooks</span><span class="sxs-lookup"><span data-stu-id="59065-172">Using webhooks</span></span>](#using-webhooks)

- [<span data-ttu-id="59065-173">Requête de blobs de contenu et limitation de requêtes</span><span class="sxs-lookup"><span data-stu-id="59065-173">Requesting content blobs and throttling</span></span>](#requesting-content-blobs-and-throttling)

<span data-ttu-id="59065-174">Nous allons vous proposer une sélection de scripts PowerShell simples pour vous aider à répondre aux questions les plus fréquemment posées par les clients ou à implémenter une solution personnalisée en montrant les principales opérations à réaliser.</span><span class="sxs-lookup"><span data-stu-id="59065-174">We'll show a selection of simple PowerShell scripts that can help you answer the most common questions asked by customers or get you started implementing a custom solution by demonstrating the main operations.</span></span> <span data-ttu-id="59065-175">Toutes les opérations ne sont pas expliquées dans ces sections, mais elles sont toutes répertoriées dans la référence API de l'activité de gestion d'Office 365. </span><span class="sxs-lookup"><span data-stu-id="59065-175">Not all the operations are explained in these sections, but they are all listed in Office 365 Management Activity API reference.</span></span>

### <a name="questions-about-third-party-tools-and-clients"></a><span data-ttu-id="59065-176">Questions sur les clients et les outils tiers</span><span class="sxs-lookup"><span data-stu-id="59065-176">Questions about third-party tools and clients</span></span>

<span data-ttu-id="59065-177">Les questions les plus courantes auxquelles nous répondons sont posées par des clients qui utilisent des produits tiers pour télécharger et agréger des données d’audit.</span><span class="sxs-lookup"><span data-stu-id="59065-177">The most common category of questions come from customers using third-party products to download and aggregate auditing data.</span></span> <span data-ttu-id="59065-178">Selon le produit tiers, les clients peuvent éprouver des difficultés pendant la configuration ou rencontrer une interruption ou une incohérence dans les données figurant dans ces produits.</span><span class="sxs-lookup"><span data-stu-id="59065-178">Depending on the third-party product, customers may encounter difficulty with the setup or experience an interruption or an inconsistency in the data exposed in those products.</span></span> <span data-ttu-id="59065-179">En premier lieu, ces clients doivent contacter l’équipe de support de leur fournisseur.</span><span class="sxs-lookup"><span data-stu-id="59065-179">Here it should be stated that the first action such customers should take is to contact their vendor's support organization.</span></span> <span data-ttu-id="59065-180">Généralement, un problème de configuration ou de service d'un fournisseur spécifique au locataire est la cause des plaintes des clients.</span><span class="sxs-lookup"><span data-stu-id="59065-180">Typically, a tenant-specific vendor configuration or service problem is the cause of customer complaints.</span></span>

### <a name="enabling-unified-audit-logging-in-office-365"></a><span data-ttu-id="59065-181">Activation de la journalisation d’audit unifié dans Office 365</span><span class="sxs-lookup"><span data-stu-id="59065-181">Enabling unified audit logging in Office 365</span></span>

<span data-ttu-id="59065-182">Si vous venez de configurer une application qui tente sans succès d’utiliser l’API d’activités de gestion, vérifiez que vous avez activé la journalisation d’audit unifié pour votre organisation Office 365.</span><span class="sxs-lookup"><span data-stu-id="59065-182">If you've just set up an app that's trying to use the Management Activity API and it's not working, be sure that you've enabled unified audit logging for your Office 365 organization.</span></span> <span data-ttu-id="59065-183">Pour ce faire, vous devez activer le journal d’audit d’Office 365.</span><span class="sxs-lookup"><span data-stu-id="59065-183">You do this by turning on the Office 365 audit log.</span></span> <span data-ttu-id="59065-184">Pour obtenir des instructions, consultez la rubrique [Activer ou désactiver la recherche dans un journal d’audit Office 365](https://docs.microsoft.com/office365/securitycompliance/turn-audit-log-search-on-or-off).</span><span class="sxs-lookup"><span data-stu-id="59065-184">For instructions, see [Turn Office 365 audit log search on or off](https://docs.microsoft.com/office365/securitycompliance/turn-audit-log-search-on-or-off).</span></span>

<span data-ttu-id="59065-185">Si l’audit unifié n’est pas activé, un message d’erreur contenant la chaîne suivante s’affiche généralement : `Microsoft.Office.Compliance.Audit``.DataServiceException: Tenant <tenantID> does not exist.`</span><span class="sxs-lookup"><span data-stu-id="59065-185">If unified auditing isn't enabled, you will typically receive an error that contains the following string: `Microsoft.Office.Compliance.Audit``.DataServiceException: Tenant <tenantID> does not exist.`</span></span>

### <a name="connecting-to-the-api"></a><span data-ttu-id="59065-186">Connexion à l’API</span><span class="sxs-lookup"><span data-stu-id="59065-186">Connecting to the API</span></span>

<span data-ttu-id="59065-187">La plupart des applications se connectent à l’API à l’aide d’un simple flux OAuth2 d’informations d’identification du client.</span><span class="sxs-lookup"><span data-stu-id="59065-187">Most applications connect to the API using a straightforward Client Credentials OAuth2 flow.</span></span> <span data-ttu-id="59065-188">Par conséquent, la première étape consiste à créer une application Azure AD ayant les autorisations nécessaires pour accéder aux données de l’API Activité de gestion.</span><span class="sxs-lookup"><span data-stu-id="59065-188">Therefore, the first step is to create an Azure AD application that has the permissions needed to access the Management Activity API data.</span></span> <span data-ttu-id="59065-189">Nous ne pouvons pas vous expliquer dans cet article comment créer une inscription d’application Azure AD.</span><span class="sxs-lookup"><span data-stu-id="59065-189">It's outside the scope of this article to explain the steps to create an Azure AD App registration.</span></span> <span data-ttu-id="59065-190">Pour en savoir plus, consultez l’article relatif à l’[inscription d’une application avec le locataire Azure Active Directory](https://docs.microsoft.com/azure/active-directory/develop/active-directory-integrating-applications).</span><span class="sxs-lookup"><span data-stu-id="59065-190">For more information, see [Register your application with your Azure Active Directory tenant](https://docs.microsoft.com/azure/active-directory/develop/active-directory-integrating-applications).</span></span>

#### <a name="azure-application-permissions"></a><span data-ttu-id="59065-191">Autorisations de l’application Azure</span><span class="sxs-lookup"><span data-stu-id="59065-191">Azure application permissions</span></span>

<span data-ttu-id="59065-192">Les trois autorisations actuellement utilisées pour l’API Activité de gestion Office 365 sont les suivantes :</span><span class="sxs-lookup"><span data-stu-id="59065-192">The three permissions currently used for the Office 365 Management Activity API are:</span></span>

1. <span data-ttu-id="59065-193">Lire les données d’activité de votre organisation</span><span class="sxs-lookup"><span data-stu-id="59065-193">Read activity data for your organization</span></span>

2. <span data-ttu-id="59065-194">Lire les informations d’état du service de votre organisation</span><span class="sxs-lookup"><span data-stu-id="59065-194">Read service health information for your organization</span></span>

3. <span data-ttu-id="59065-195">Lire les événements de la politique Protection contre la perte de données (DLP), y compris les informations sensibles détectées</span><span class="sxs-lookup"><span data-stu-id="59065-195">Read Data Loss Prevention (DLP) policy events, including detected sensitive information</span></span>

> [!NOTE]
> <span data-ttu-id="59065-196">Nous vous recommandons d’activer les Autorisations d’application et les Autorisations déléguées au moins pour les deux premiers jeux d’autorisations ci-dessus.</span><span class="sxs-lookup"><span data-stu-id="59065-196">You should enable both the Application Permissions and the Delegated Permissions for at least the first two of the above permission sets.</span></span> <span data-ttu-id="59065-197">L’autorisation Lire les événements de la stratégie DLP vous sera utile uniquement si vous êtes intéressé par les charges de travail DLP.</span><span class="sxs-lookup"><span data-stu-id="59065-197">Read DLP policy events will only be necessary if you are interested in the DLP workloads.</span></span>

#### <a name="getting-an-access-token"></a><span data-ttu-id="59065-198">Obtention d’un jeton d’accès</span><span class="sxs-lookup"><span data-stu-id="59065-198">Getting an access token</span></span>

<span data-ttu-id="59065-199">Le script PowerShell suivant utilise l’ID de l’application et une clé secrète client pour obtenir le jeton OAuth2 auprès du point de terminaison d’authentification de l’API Activité de gestion.</span><span class="sxs-lookup"><span data-stu-id="59065-199">The following PowerShell script uses the App ID and a Client Secret to obtain the OAuth2 token from the Management Activity API authentication endpoint.</span></span> <span data-ttu-id="59065-200">Il place ensuite le jeton d'accès dans la `$headerParams` variable de tableau, que vous joindrez à votre requête HTTP.</span><span class="sxs-lookup"><span data-stu-id="59065-200">It then places the access token into the `$headerParams` array variable, which you'll attach to your HTTP request.</span></span> <span data-ttu-id="59065-201">Pour la valeur du point de terminaison de l’API (dans la variable $resource), utilisez l’une des valeurs suivantes, selon l’offre d’abonnement Microsoft 365 ou Office 365 de votre organisation :</span><span class="sxs-lookup"><span data-stu-id="59065-201">For the value for the API endpoint (in the $resource variable) use one of the following values based on your organization's Microsoft 365 or Office 365 subscription plan:</span></span>

- <span data-ttu-id="59065-202">Offre pour le secteur privé : `manage.office.com`</span><span class="sxs-lookup"><span data-stu-id="59065-202">Enterprise plan: `manage.office.com`</span></span>

- <span data-ttu-id="59065-203">Offre pour le secteur public (Cloud de la communauté du secteur public) : `manage-gcc.office.com`</span><span class="sxs-lookup"><span data-stu-id="59065-203">GCC government plan: `manage-gcc.office.com`</span></span>

- <span data-ttu-id="59065-204">Offre pour le secteur public (Cloud de la communauté du secteur public à haute disponibilité, ou « GCC High  ») : `manage.office365.us`</span><span class="sxs-lookup"><span data-stu-id="59065-204">GCC High government plan: `manage.office365.us`</span></span>

- <span data-ttu-id="59065-205">Offre pour le secteur public (Département de la Défense) : `manage.protection.apps.mil`</span><span class="sxs-lookup"><span data-stu-id="59065-205">DoD government plan: `manage.protection.apps.mil`</span></span>

```powershell
# Create app of type Web app / API in Azure AD, generate a Client Secret, and update the client id and client secret here
$ClientID = "<YOUR_APPLICATION_ID"
$ClientSecret = "<YOUR_CLIENT_SECRET>"
$loginURL = "https://login.microsoftonline.com/"
$tenantdomain = "<YOUR_DOMAIN>.onmicrosoft.com"
# Get the tenant GUID from Properties | Directory ID under the Azure Active Directory section. For $resource, use one of these endpoint values based on your subscription plan: Enterprise - manage.office.com; GCC - manage-gcc.office.com; GCC High: manage.office365.us; DoD: manage.protection.apps.mil
$TenantGUID = "<YOUR_TENANT_GUID>"
$resource = "https://<YOUR_API_ENDPOINT>"
# auth
$body = @{grant_type="client_credentials";resource=$resource;client_id=$ClientID;client_secret=$ClientSecret}
$oauth = Invoke-RestMethod -Method Post -Uri $loginURL/$tenantdomain/oauth2/token?api-version=1.0 -Body $body
$headerParams = @{'Authorization'="$($oauth.token_type) $($oauth.access_token)"} 
```

<span data-ttu-id="59065-206">La variable `$oauth` contient l’objet de réponse, qui comporte plusieurs propriétés dont le jeton d’accès.</span><span class="sxs-lookup"><span data-stu-id="59065-206">The `$oauth` variable will contain the response object, which has several properties including the access token.</span></span> <span data-ttu-id="59065-207">Voici un exemple de réponse :</span><span class="sxs-lookup"><span data-stu-id="59065-207">Here's an example of a response:</span></span>

```json
token_type     : Bearer
expires_in     : 3599
ext_expires_in : 0
expires_on     : 1508285860
not_before     : 1508281960
resource       : https://manage.office.com
access_token   : eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6IjJLVmN1enFBaWRPTHFXU2FvbDd3Z0ZSR0NZbyIsImtpZCI6IjJLVmN1enFBaWRPTHFXU2FvbDd3Z0ZSR0NZbyJ9.eyJhdWQiOiJodHRwczov…
```

### <a name="checking-your-subscriptions"></a><span data-ttu-id="59065-208">Vérification de vos abonnements</span><span class="sxs-lookup"><span data-stu-id="59065-208">Checking your subscriptions</span></span>

<span data-ttu-id="59065-209">Quand on constate une interruption du flux de données à destination d’une solution ou d’un client de l’API Activité de gestion existant, il est normal de se demander si quelque chose est arrivé à l’abonnement.</span><span class="sxs-lookup"><span data-stu-id="59065-209">If you've experienced an interruption in data flowing to an existing Management Activity API client or solution, you might wonder if something happened to your subscription.</span></span> <span data-ttu-id="59065-210">Pour vérifier vos abonnements actifs, ajoutez ce qui suit au script précédent :</span><span class="sxs-lookup"><span data-stu-id="59065-210">To check your active subscriptions, add the following to the previous script:</span></span>

```powershell
Invoke-WebRequest -Headers $headerParams -Uri "$resource/api/v1.0/$tenantGUID/activity/feed/subscriptions/list" 
```

#### <a name="sample-response"></a><span data-ttu-id="59065-211">Exemple de réponse</span><span class="sxs-lookup"><span data-stu-id="59065-211">Sample response</span></span>

```json
StatusCode        : 200
Status Description : OK
Content           : [{"contentType":"Audit.Exchange","status":"enabled","webhook":null},{"contentType":"Audit.SharePoint","status":"enabled","webhook":{"authId":"","address":"https://mvcwebapiwebhookreceiver.azurewebsite...
RawContent        : HTTP/1.1 200 OK
                    Pragma: no-cache
                    Content-Length: 266
                    Cache-Control: no-cache
                    Content-Type: application/json; charset=utf-8
                    Expires: -1
                    Server: Microsoft-IIS/8.5,Microsoft-IIS/8.5
                    X-AspNet-Versi...
Forms             : {}
Headers           : {[Pragma, no-cache], [Content-Length, 266], [Cache-Control, no-cache], [Content-Type, application/json; charset=utf-8]...}
Images            : {}
InputFields       : {}
Links             : {}
ParsedHtml        : mshtml.HTMLDocumentClass
RawContentLength  : 266
```

<span data-ttu-id="59065-212">Cette réponse indique que les abonnements Audit.Exchange et Audit.SharePoint sont activés dans le locataire.</span><span class="sxs-lookup"><span data-stu-id="59065-212">This says that the tenant has both Audit.Exchange and Audit.SharePoint subscriptions enabled.</span></span> <span data-ttu-id="59065-213">Aucun webhook n’est activé (null) dans l’abonnement Exchange. Dans l’abonnement SharePoint, un webhook est activé et l’adresse du point de terminaison inscrit est affichée.</span><span class="sxs-lookup"><span data-stu-id="59065-213">The Exchange subscription has no webhook enabled (null) and the SharePoint subscription has a webhook enabled with the address of the registered endpoint shown.</span></span>

### <a name="creating-a-new-subscription"></a><span data-ttu-id="59065-214">Création d’un abonnement</span><span class="sxs-lookup"><span data-stu-id="59065-214">Creating a new subscription</span></span>

<span data-ttu-id="59065-215">Pour créer un abonnement, utilisez l’opération /start.</span><span class="sxs-lookup"><span data-stu-id="59065-215">To create a new subscription, you use the /start operation.</span></span> <span data-ttu-id="59065-216">Pour le point de terminaison de l’API, utilisez l’une de ces valeurs selon votre type d’abonnement :</span><span class="sxs-lookup"><span data-stu-id="59065-216">For the API endpoint, use one of these values base on your subscription plan:</span></span>

- <span data-ttu-id="59065-217">Offre pour le secteur privé : `manage.office.com`</span><span class="sxs-lookup"><span data-stu-id="59065-217">Enterprise plan: `manage.office.com`</span></span>

- <span data-ttu-id="59065-218">Offre pour le secteur public (Cloud de la communauté du secteur public) : `manage-gcc.office.com`</span><span class="sxs-lookup"><span data-stu-id="59065-218">GCC government plan: `manage-gcc.office.com`</span></span>

- <span data-ttu-id="59065-219">Offre pour le secteur public (Cloud de la communauté du secteur public à haute disponibilité, ou « GCC High  ») : `manage.office365.us`</span><span class="sxs-lookup"><span data-stu-id="59065-219">GCC High government plan: `manage.office365.us`</span></span>

- <span data-ttu-id="59065-220">Plan pour le secteur public DoD : `manage.protection.apps.mil`</span><span class="sxs-lookup"><span data-stu-id="59065-220">DoD government plan: `manage.protection.apps.mil`</span></span>

```powershell
Invoke-WebRequest -Method Post -Headers $headerParams -Uri "https://<YOUR_API_ENDPOINT>/api/v1.0/$tenantGUID/activity/feed/subscriptions/start?contentType=Audit.AzureActiveDirectory"

> [!NOTE]
> Remember that `$headerParams` was populated in the first part of the script listed in the [Connecting to the API](#connecting-to-the-api) section in this article.

The previous code will create a new subscription to the Audit.AzureActiveDirectory content type, with a webhook that is null. You can then check your subscriptions using the code in the [Checking your subscriptions](#checking-your-subscriptions) section in this article.

## Checking content availability

To check what content blobs were created during a certain period, you can add the following line to the script in the “Connecting to the API” section.

```powershell
Invoke-WebRequest -Method GET -Headers $headerParams -Uri "$resource/api/v1.0/$tenantGUID/activity/feed/subscriptions/content?contentType=Audit.SharePoint"
```

<span data-ttu-id="59065-221">L’exemple précédent reçoit les notifications de contenu mis à disposition aujourd’hui, entre 12:00 AM UTC et l’heure actuelle.</span><span class="sxs-lookup"><span data-stu-id="59065-221">The previous example will get all the content notifications that became available today, which means from 12:00 AM UTC to the current time.</span></span> <span data-ttu-id="59065-222">Si vous voulez indiquer une période différente (en gardant à l’esprit que vous ne pouvez pas interroger l’API sur des périodes supérieures à 24 heures), ajoutez les paramètres *starttime* et *endtime* à l’URI. Par exemple :</span><span class="sxs-lookup"><span data-stu-id="59065-222">If you want to specify a different time period (keeping in mind that the maximum period for which you can query is 24 hours), add the *starttime* and *endtime* parameters to the URI; for example:</span></span>

```powershell
Invoke-WebRequest -Method GET -Headers $headerParams -Uri "$resource/api/v1.0/$tenantGUID/activity/feed/subscriptions/content?contentType=Audit.SharePoint&startTime=2017-10-13T00:00&endTime=2017-10-13T11:59"
```

> [!NOTE]
> <span data-ttu-id="59065-223">Les paramètres *starttime* et *endtime* peuvent être utilisés uniquement ensemble.</span><span class="sxs-lookup"><span data-stu-id="59065-223">You must use either both *starttime* and *endtime* parameters or neither.</span></span>

```json
[{      "contentUri" : "https://<your_API_endpoint>/api/v1.0/<your_tenant_guid>/activity/feed/audit/20171014180051748005825$20171014180051748005825$audit_sharepoint$Audit_SharePoint",
        "contentId" : "20171014180051748005825$20171014180051748005825$audit_sharepoint$Audit_SharePoint",
        "contentType" : "Audit.SharePoint",
        "contentCreated" : "2017-10-13T18:00:51.748Z",
        "contentExpiration" : "2017-10-20T18:00:51.748Z",
}]
```

> [!IMPORTANT]
>
> - <span data-ttu-id="59065-224">La propriété *contentUri* est l’URI qui vous permet de récupérer le blob de contenu.</span><span class="sxs-lookup"><span data-stu-id="59065-224">The *contentUri* property is the URI from which you can retrieve the content blob.</span></span> <span data-ttu-id="59065-225">Le blob contient les détails des événements, et ce pour 1 – N événements.</span><span class="sxs-lookup"><span data-stu-id="59065-225">The blob itself is what contains the event details; it will contain details about 1 – N events.</span></span> <span data-ttu-id="59065-226">Alors que la collection peut contenir 30 objets JSON, il peut y avoir davantage de détails d’événements dans ces 30 URI de contenu.</span><span class="sxs-lookup"><span data-stu-id="59065-226">While there may be 30 JSON objects in the collection, there may be many more events detailed in those 30 content URIs.</span></span>
>
> - <span data-ttu-id="59065-227">La propriété *contentCreated* ne correspond pas à la date à laquelle l’événement notifié a été créé.</span><span class="sxs-lookup"><span data-stu-id="59065-227">The *contentCreated* property is not the date that the event being notified was created.</span></span> <span data-ttu-id="59065-228">Il s’agit de la date à laquelle la notification a été créée.</span><span class="sxs-lookup"><span data-stu-id="59065-228">This is the date the notification was created.</span></span> <span data-ttu-id="59065-229">Les événements détaillés dans ce blob ont peut-être été créés bien avant le blob de contenu.</span><span class="sxs-lookup"><span data-stu-id="59065-229">The events detailed in that blob may have been created well before the content blob was created.</span></span> <span data-ttu-id="59065-230">Par conséquent, vous ne pouvez jamais interroger directement l’API sur les événements survenus pendant une période donnée.</span><span class="sxs-lookup"><span data-stu-id="59065-230">Therefore, you can never query the API directly for events that occurred within any given period.</span></span>

#### <a name="paging-contents-for-busy-tenants"></a><span data-ttu-id="59065-231">Pagination du contenu pour les locataires occupés</span><span class="sxs-lookup"><span data-stu-id="59065-231">Paging contents for busy tenants</span></span>

<span data-ttu-id="59065-232">Dans de nombreux locataires Office 365 plus importants, des milliers d’événements peuvent être générés en une heure.</span><span class="sxs-lookup"><span data-stu-id="59065-232">Many larger Office 365 tenants have thousands of events being generated every hour.</span></span> <span data-ttu-id="59065-233">Si c’est le cas dans votre organisation, et si vous essayez d’exécuter une requête pour une période de 24 heures comme dans l’exemple ci-dessus, il peut être utile de récupérer davantage de notifications pouvant être renvoyées dans une seule réponse.</span><span class="sxs-lookup"><span data-stu-id="59065-233">If this is the case with your organization, and you try to execute a query for a 24-hour period like in the example above, you may need to retrieve more notifications than can be returned in one response.</span></span> <span data-ttu-id="59065-234">Dans ce cas, nous vous recommandons d’implémenter une boucle logique qui vérifie si les en-têtes de réponse contiennent la valeur **NextPageUrl:**.</span><span class="sxs-lookup"><span data-stu-id="59065-234">In this case, you'll need to implement a logical loop of some kind, each time checking the response headers for the **NextPageUrl:** header value.</span></span> <span data-ttu-id="59065-235">Voir la section Pagination dans la référence API de l'activité de gestion Office 365 pour plus de détails.</span><span class="sxs-lookup"><span data-stu-id="59065-235">See the Pagination section in the Office 365 Management Activity API reference for more details.</span></span>

```powershell
IF the NextPageUrl header is present in the response... 

THEN issue a new request substituting the Uri parameter in the above Invoke-WebRequest example for the value of the NextPageUrl header...
 
ELSE exit the loop
```

<span data-ttu-id="59065-236">Il sera difficile de tester ce code en boucle, sauf si votre locataire est très actif.</span><span class="sxs-lookup"><span data-stu-id="59065-236">It will be difficult to test this looping code unless you have a very active tenant.</span></span> <span data-ttu-id="59065-237">Dans notre test, nous avons essayé d’exécuter des milliers d’opérations de mise à jour dans un script. Le nombre de notifications généré était insuffisant pour exiger l’envoi de l’en-tête **NextPageUrl**.</span><span class="sxs-lookup"><span data-stu-id="59065-237">In our testing, we tried to execute several thousand update operations in a script and was unable to generate a large enough number of notifications to require the **NextPageUrl** header to be sent.</span></span>

### <a name="using-webhooks"></a><span data-ttu-id="59065-238">Utilisation des webhooks</span><span class="sxs-lookup"><span data-stu-id="59065-238">Using webhooks</span></span>

<span data-ttu-id="59065-239">Deux approches vous permettent de recevoir une notification créée par les blobs de contenu.</span><span class="sxs-lookup"><span data-stu-id="59065-239">There two ways to get a notification that content blobs have been created.</span></span> <span data-ttu-id="59065-240">L’approche *push* est implémentée avec un point de terminaison de webhook, qui correspond à une application web que vous créez et hébergez vous-même ou sur une plateforme cloud.</span><span class="sxs-lookup"><span data-stu-id="59065-240">The *push* approach is implemented with a webhook endpoint, which is a web application that you create and host yourself or on a cloud platform.</span></span> <span data-ttu-id="59065-241">Inscrivez le webhook quand vous créez un abonnement à un type de contenu audité.</span><span class="sxs-lookup"><span data-stu-id="59065-241">You register the webhook at the time you create a subscription to an audited content type.</span></span> <span data-ttu-id="59065-242">Vous pouvez également ajouter une inscription de webhook à un abonnement existant à l’aide de l’approche illustrée ci-dessous.</span><span class="sxs-lookup"><span data-stu-id="59065-242">You may also add a webhook registration to an existing subscription using the approach shown below.</span></span> <span data-ttu-id="59065-243">L’approche *pull* vous oblige à interroger pour une période particulière (pas plus de 24 heures) en utilisant l’opération /contenu.</span><span class="sxs-lookup"><span data-stu-id="59065-243">The *pull* approach requires you to query for a particular timespan (no more than 24 hours) using the /content operation.</span></span> <span data-ttu-id="59065-244">La réponse vous indique les blobs de contenu qui ont été créés pendant la période spécifiée.</span><span class="sxs-lookup"><span data-stu-id="59065-244">The response will tell you which content blobs were created during the period specified.</span></span>

<span data-ttu-id="59065-245">Avant d’ajouter un webhook, vous devez connaître les aspects suivants :</span><span class="sxs-lookup"><span data-stu-id="59065-245">Before you add a webhook, be aware of the following two issues:</span></span>

1. <span data-ttu-id="59065-246">Les webhooks ne sont plus mis en avant par Microsoft en raison des difficultés rencontrées pour les déboguer et les dépanner.</span><span class="sxs-lookup"><span data-stu-id="59065-246">Webhooks are being de-emphasized by Microsoft because of the difficulty in debugging and troubleshooting.</span></span> <span data-ttu-id="59065-247">En règle générale, il faut héberger un point de terminaison WebApi qui répond à des requêtes entrantes.</span><span class="sxs-lookup"><span data-stu-id="59065-247">Typically, you would host a WebApi endpoint that responds to incoming requests.</span></span> <span data-ttu-id="59065-248">De nombreux clients utilisent soit des environnements d’hébergement (qu’ils ne contrôlent pas totalement), soit des environnements locaux (qui ont des difficultés à autoriser les requêtes HTTP entrantes).</span><span class="sxs-lookup"><span data-stu-id="59065-248">Many customers either use hosting environments (which they don't have full control over) or on-premises environments (that have difficulty allowing incoming HTTP requests).</span></span> <span data-ttu-id="59065-249">L’équipe de support a reçu de nombreuses questions liées à des problèmes où les requêtes entrantes provenant du pipeline d’audit Office 365 étaient bloquées par un pare-feu ou un routeur.</span><span class="sxs-lookup"><span data-stu-id="59065-249">Support has seen many problems where the incoming requests from the Office 365 auditing pipeline have been blocked by a firewall or router.</span></span> <span data-ttu-id="59065-250">Dans ce cas, l’API implémente un algorithme d’interruption qui peut être source de confusion et entraîner la désactivation du webhook dans l’abonnement.</span><span class="sxs-lookup"><span data-stu-id="59065-250">In this case, the API will implement a back-off algorithm, which can be confusing and may result in disabling the webhook in the subscription.</span></span>

2. <span data-ttu-id="59065-251">Le webhook doit être prêt à répondre immédiatement à une requête de validation quand l’opération /start est exécutée.</span><span class="sxs-lookup"><span data-stu-id="59065-251">The webhook must be ready to immediately respond to a validation request after the start operation is executed.</span></span> <span data-ttu-id="59065-252">S’il y a un bogue dans l’application webhook, la validation échoue et le webhook n’est pas activé.</span><span class="sxs-lookup"><span data-stu-id="59065-252">If there is a bug in the webhook application, the validation will fail, and the webhook will not be enabled.</span></span> <span data-ttu-id="59065-253">Pour en savoir plus sur le schéma de requête de validation, consultez la section relative à la validation du webhook dans la référence de l’API Activité de gestion Office 365.</span><span class="sxs-lookup"><span data-stu-id="59065-253">For information about the validation request schema, see the Webhook validation section in the Office 365 Management Activity API reference.</span></span> <span data-ttu-id="59065-254">Nous vous conseillons d’envisager sérieusement les difficultés que vous pourriez rencontrer en produisant un webhook prêt pour la production pour répondre aux notifications de l’API Activité de gestion.</span><span class="sxs-lookup"><span data-stu-id="59065-254">You should seriously consider the challenges in producing a production-ready webhook to respond to Management Activity API notifications.</span></span>

<span data-ttu-id="59065-255">Si vous décidez d’implémenter un webhook, il doit être testé pour vérifier que le point de terminaison est prêt à envoyer une réponse HTTP 200 à la requête de validation et aux demandes de notification normales avant le premier appel d’une opération /start indiquant un point de terminaison de webhook.</span><span class="sxs-lookup"><span data-stu-id="59065-255">If you decide to implement a webhook, it should be tested to verify that the endpoint is prepared to respond with an HTTP 200 response to both the validation request and the normal notification requests before any /start operation that specifies a webhook endpoint is called for the first time.</span></span> <span data-ttu-id="59065-256">En règle générale, il est préférable d’envoyer une requête factice à partir de l’API pour tester la préparation du webhook.</span><span class="sxs-lookup"><span data-stu-id="59065-256">Typically, you would use a mocked request from the API to test this readiness.</span></span> <span data-ttu-id="59065-257">Lisez attentivement les sections relatives à la validation du webhook et à la récupération du contenu dans la référence de l’API Activité de gestion Office 365 pour comprendre le schéma de ces deux types de requêtes.</span><span class="sxs-lookup"><span data-stu-id="59065-257">Carefully read and observe both the Webhook validation and Retrieving content sections in the Office 365 Management Activity API reference to understand the schema of these two types of requests.</span></span>

<span data-ttu-id="59065-258">Pour ajouter un abonnement associé à un point de terminaison de webhook, ajoutez un paramètre BODY à la méthode POST du point de terminaison /start. Par exemple :</span><span class="sxs-lookup"><span data-stu-id="59065-258">To add a subscription with a webhook endpoint, add a body parameter to the POST to the /start endpoint; for example:</span></span>

```json
$body = '{
    "webhook" : {
        "address": "https://webhook.myapp.com/o365/",
        "authId": "o365activityapinotification",
        "expiration": ""
    }}'
$uri = "https://manage.office.com/api/v1.0/$tenantGUID/activity/feed//subscriptions/start?contentType=Audit.SharePoint"
Invoke-RestMethod -Method Post -uri $uri -Headers $headerParams -Body $body
```

<span data-ttu-id="59065-259">Immédiatement après cet appel, une requête de validation est envoyée à l’URI `https://webhook.myapp.com/o365/ …`. Un détecteur doit être prêt à répondre conformément à la description présente dans la section relative à la validation du webhook de la référence de l’API Activité de gestion Office 365.</span><span class="sxs-lookup"><span data-stu-id="59065-259">Immediately following this call, a validation request will be sent out to `https://webhook.myapp.com/o365/ …` and there should be a listener ready to respond, as per the description in the Webhook validation section in the Office 365 Management Activity API reference.</span></span> <span data-ttu-id="59065-260">Votre détecteur doit envoyer une réponse HTTP 200.</span><span class="sxs-lookup"><span data-stu-id="59065-260">Your listener must respond with HTTP 200.</span></span> <span data-ttu-id="59065-261">Si vous exécutez immédiatement l’opération /list à ce stade, le webhook affichera null jusqu’à ce que la validation soit renvoyée.</span><span class="sxs-lookup"><span data-stu-id="59065-261">If you immediately run the /list operation at this point, you will not see the webhook shown as other than null until the validation has returned successfully.</span></span>

#### <a name="checking-notifications-to-webhooks"></a><span data-ttu-id="59065-262">Vérification des notifications envoyées aux webhooks</span><span class="sxs-lookup"><span data-stu-id="59065-262">Checking notifications to webhooks</span></span>

<span data-ttu-id="59065-263">Il est important de faire la distinction entre l'opération /notifications et l'opération /contenu.</span><span class="sxs-lookup"><span data-stu-id="59065-263">It's important to distinguish between the /notifications operation and the /content operation.</span></span> <span data-ttu-id="59065-264">Il est utile de vérifier les notifications uniquement si vous vous êtes abonné auprès d’un point de terminaison de webhook.</span><span class="sxs-lookup"><span data-stu-id="59065-264">Checking notifications is only relevant if you have subscribed with a webhook endpoint.</span></span> <span data-ttu-id="59065-265">Cette opération vous permettra de savoir si les tentatives d’envoi des notifications à votre webhook ont réussi.</span><span class="sxs-lookup"><span data-stu-id="59065-265">This operation will let you know if attempts to send notifications to your webhook have been successful or not.</span></span> <span data-ttu-id="59065-266">Cette opération ne doit pas être utilisée pour lister le contenu disponible.</span><span class="sxs-lookup"><span data-stu-id="59065-266">This operation should not be used to list available content.</span></span> <span data-ttu-id="59065-267">Pour vérifier la disponibilité du contenu par rapport à ce que vous avez peut-être déjà reçu dans votre webhook, utilisez l’opération /content.</span><span class="sxs-lookup"><span data-stu-id="59065-267">To cross-check the availability of content against what you may have already received in your webhook, you would use the /content operation.</span></span> <span data-ttu-id="59065-268">Avant toute chose, vérifiez si vous avez reçu des notifications d’échec en utilisant l’opération /notifications.</span><span class="sxs-lookup"><span data-stu-id="59065-268">But be sure to first check for failed notifications using the /notifications operation.</span></span>

### <a name="requesting-content-blobs-and-throttling"></a><span data-ttu-id="59065-269">Requête de blobs de contenu et limitation de requêtes</span><span class="sxs-lookup"><span data-stu-id="59065-269">Requesting content blobs and throttling</span></span>

<span data-ttu-id="59065-270">Dès que vous avez obtenu la liste des URI de contenu, demandez les blobs spécifiés par les URI.</span><span class="sxs-lookup"><span data-stu-id="59065-270">After you've obtained a list of content URIs, you must request the blobs specified by the URIs.</span></span> <span data-ttu-id="59065-271">Voici un exemple de requête d’un blob de contenu (en utilisant le point de terminaison de l’API manage.office.com pour les organisations d’entreprise) avec PowerShell.</span><span class="sxs-lookup"><span data-stu-id="59065-271">The following is an example of requesting a content blob (using the manage.office.com API endpoint for Enterprise organizations) using PowerShell.</span></span> <span data-ttu-id="59065-272">Cet exemple part du principe que vous avez déjà utilisé l’exemple précédent de la section [Obtention d’un jeton d’accès](#getting-an-access-token) de cet article pour obtenir un jeton d’accès et remplir la variable `$headerParams` comme il se doit.</span><span class="sxs-lookup"><span data-stu-id="59065-272">This example assumes you have already used the previous example in the [Getting an access token](#getting-an-access-token) section in this article to get an access token and have populated the `$headerParams` variable appropriately.</span></span>

```powershell
# Get a content blob
$uri = 'https://manage.office.com/api/v1.0/<<your-tenant-guid>>/activity/feed/audit/<<ContentID>$audit_sharepoint$Audit_SharePoint'
$contents = Invoke-WebRequest -Method GET -Headers $headerParams -Uri $uri
```

<span data-ttu-id="59065-273">Quelques remarques concernant la variable *$uri* utilisée dans l’exemple précédent :</span><span class="sxs-lookup"><span data-stu-id="59065-273">Note the following things about the *$uri* variable in the previous example:</span></span>

- <span data-ttu-id="59065-274">Nous avons utilisé des guillemets simples pour *$* éviter toute interprétation des symboles en tant que variables dans PowerShell</span><span class="sxs-lookup"><span data-stu-id="59065-274">We used single quotes so that the *$* symbols aren't interpreted as variables in PowerShell</span></span>

- <span data-ttu-id="59065-275">L’URI entière est renvoyée dans la propriété *contentUri* de la réponse à l’appel précédent passé au point de terminaison /content.</span><span class="sxs-lookup"><span data-stu-id="59065-275">The entire URI will be returned in the *contentUri* property of the response to your previous call to the /content endpoint.</span></span> <span data-ttu-id="59065-276">Les jetons d’espace réservé affichés sont fournis à titre d’exemple uniquement.</span><span class="sxs-lookup"><span data-stu-id="59065-276">The placeholder tokens shown are just for illustration.</span></span>

<span data-ttu-id="59065-277">Quand ils tentent de récupérer les blobs de contenu disponibles, de nombreux clients (utilisant principalement des locataires occupés) rencontrent des erreurs semblables à celles-ci :</span><span class="sxs-lookup"><span data-stu-id="59065-277">When attempting to retrieve the available content blobs, many customers (mostly working with busy tenants) have experienced errors that look like this:</span></span>

```json
Response Code 403: {'error':{'code':'AF429','message':'Too many requests. Method=GetBlob, PublisherId=00000000-0000-0000-0000-000000000000'}}
```

<span data-ttu-id="59065-278">Cette erreur est probablement due à la limitation des requêtes.</span><span class="sxs-lookup"><span data-stu-id="59065-278">This is likely due to throttling.</span></span> <span data-ttu-id="59065-279">Notez que la valeur du paramètre PublisherId indique probablement que le client n’a pas spécifié *PublisherIdentifier* dans la requête.</span><span class="sxs-lookup"><span data-stu-id="59065-279">Note that the value of the PublisherId parameter likely indicates that the client didn't specify the *PublisherIdentifier* in the request.</span></span> <span data-ttu-id="59065-280">Par ailleurs, n’oubliez pas que le nom correct du paramètre est *PublisherIdentifier* même si *PublisherId* est répertorié dans les réponses de l’erreur 403.</span><span class="sxs-lookup"><span data-stu-id="59065-280">Also, keep in mind that the correct parameter name is *PublisherIdentifier* even though you see *PublisherId* listed in the 403 error responses.</span></span>

> [!NOTE]
> <span data-ttu-id="59065-281">Dans la référence de l’API, le paramètre *PublisherIdentifier* figure dans chaque opération de l’API, mais il doit également être inclus dans la requête GET envoyée à l’URL contentUri pendant la récupération du blob de contenu.</span><span class="sxs-lookup"><span data-stu-id="59065-281">In the API reference, the *PublisherIdentifier* parameter is listed in every operation of the API, but it should also be included in the GET request to the contentUri URL when retrieving the content blob.</span></span>

<span data-ttu-id="59065-282">Si vous effectuez des appels d’API simples pour résoudre des problèmes (par exemple, pour vérifier si un abonnement est actif), vous pouvez ignorer sereinement le paramètre *PublisherIdentifier*. En revanche, tout code destiné à la production doit inclure le paramètre *PublisherIdentifier* dans chaque appel.</span><span class="sxs-lookup"><span data-stu-id="59065-282">If you're doing simple API calls to troubleshoot problems (for example, checking if a given subscription is active) you can safely omit the *PublisherIdentifier* parameter, but absolutely any code that is eventually meant for production use should include the *PublisherIdentifier* parameter on every call.</span></span>

<span data-ttu-id="59065-283">Si vous mettez en place un client pour le locataire de votre entreprise, le paramètre *PublisherIdentifier* est le GUID du locataire.</span><span class="sxs-lookup"><span data-stu-id="59065-283">If you're implementing a client for your company's tenant, the *PublisherIdentifier* is the Tenant GUID.</span></span> <span data-ttu-id="59065-284">Si vous créez une application ISV ou un complément tiers pour plusieurs clients, le paramètre *PublisherIdentifier* devrait être le GUID du locataire de l'ISV, et non le GUID du locataire de l'entreprise de l'utilisateur final.</span><span class="sxs-lookup"><span data-stu-id="59065-284">If you are creating an ISV application or add-in for multiple customers, the *PublisherIdentifier* should be the ISV's Tenant GUID, and not the tenant GUID of end user's company.</span></span>

<span data-ttu-id="59065-285">Si vous incluez le paramètre *PublisherIdentifier* valide, votre application sera dans un pool qui reçoit 60 000 requêtes par minute par locataire.</span><span class="sxs-lookup"><span data-stu-id="59065-285">If you include the valid *PublisherIdentifier* , then you will be in a pool that is allotted 60K requests per minute per tenant.</span></span> <span data-ttu-id="59065-286">Il s’agit d’un nombre incroyablement élevé de requêtes.</span><span class="sxs-lookup"><span data-stu-id="59065-286">This is an exceptionally large number of requests.</span></span> <span data-ttu-id="59065-287">Toutefois, si vous n’incluez pas le paramètre *PublisherIdentifier* , votre application sera dans le pool général qui reçoit 60 000 requêtes par minute pour tous les locataires.</span><span class="sxs-lookup"><span data-stu-id="59065-287">However, if you don't include the *PublisherIdentifier* parameter, you will be in the general pool allotted 60K requests per minute for all tenants.</span></span> <span data-ttu-id="59065-288">Dans ce cas, vous trouverez certainement que vos appels sont limités.</span><span class="sxs-lookup"><span data-stu-id="59065-288">In this case, you will more than likely find that your calls are getting throttled.</span></span> <span data-ttu-id="59065-289">Pour éviter cela, voici comment vous pouvez demander un blob de contenu à l’aide du paramètre *PublisherIdentifier*  :</span><span class="sxs-lookup"><span data-stu-id="59065-289">To prevent this, here's how you would request a content blob using the *PublisherIdentifier* :</span></span>

```json
$contentUri = ($response.Content | ConvertFrom-Json).contentUri[0]
$uri = $contentUri + '?PublisherIdentifier=82b24b6d-0591-4604-827b-705d55d0992f'
$contents = Invoke-WebRequest -Method GET -Headers $headerParams -Uri $uri
```

<span data-ttu-id="59065-290">L’exemple précédent part du principe que la variable *$response* a été remplie avec la réponse d’une requête envoyée au point de terminaison /content et que la variable *$headerParams* inclut un jeton d’accès valide.</span><span class="sxs-lookup"><span data-stu-id="59065-290">The previous example assumes that the *$response* variable was populated with the response to a request to the /content endpoint and that the *$headerParams* variable includes a valid access token.</span></span> <span data-ttu-id="59065-291">Le script prend le premier élément de la matrice des URI de contenu dans la réponse, puis invoque la méthode GET pour télécharger ce blob et le placer dans la variable *$contents*.</span><span class="sxs-lookup"><span data-stu-id="59065-291">The script grabs the first item in the array of content URIs from the response and then invokes the GET to download that blob and put it in the *$contents* variable.</span></span> <span data-ttu-id="59065-292">Votre code va probablement exécuter des boucles dans la collection contentUri, en émettant la méthode GET pour chaque *contentUri*.</span><span class="sxs-lookup"><span data-stu-id="59065-292">Your code will likely loop through the contentUri collection, issuing the GET for each *contentUri*.</span></span>
